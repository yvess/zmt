#!/usr/bin/env python3
# coding: utf-8

import argparse
import subprocess


class ZfsTools:
    def __init__(self, args):
        self.args = args

    def autosnap(self):
        snaps = subprocess.check_output(
            "zfs list -H -S creation -r -o name,creation -t snap tank",
            universal_newlines=True, shell=True
        )
        print(snaps)

    def backup(self):
        snaps = subprocess.check_output(
            "zfs list -H -S creation -r -o name,creation -t snap backup",
            universal_newlines=True, shell=True
        )
        print(snaps)


class ZfsParser:
    def __init__(self):
        self.parser = argparse.ArgumentParser(
            description="""zfs management tools,
                           for snapshoting, replication, backup""")
        self.subparsers = self.parser.add_subparsers(
            help='avaiable commands')
        self.parser_autosnap(self.subparsers)
        self.parser_backup(self.subparsers)

    def run(self):
        args = self.parser.parse_args()
        if not hasattr(args, 'command'):
            self.parser.print_help()
            exit()
        zfstools = ZfsTools(args)

        if hasattr(zfstools, args.command):
            getattr(zfstools, args.command)()
        else:
            print('command %s not known' % args.command)

    def parser_autosnap(self, subparsers):
        parser_autosnap = self.subparsers.add_parser(
            'autosnap',
            help='create a snapshot'
        )
        parser_autosnap.add_argument('--bar', help='bar help')
        parser_autosnap.set_defaults(command='autosnap')

    def parser_backup(self, subparsers):
        parser_backup = self.subparsers.add_parser(
            'backup',
            help='create a backup'
        )
        parser_backup.add_argument('--bar', help='bar help')
        parser_backup.set_defaults(command='backup')


def main():
    # main parser
    zfs_parser = ZfsParser()
    zfs_parser.run()


if __name__ == '__main__':
    main()
